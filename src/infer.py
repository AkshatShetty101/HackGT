'''
Objectives:
Tell table to chairs mapping, if table exists 
Tell chair to location mapping
Tell table to location mapping

Table - {centroid, chairs, confidence}
Chair - {centroid, confidence}
'''
from PIL import Image
import numpy as np

classes = {
    0: '__background__', 1: 'person', 2: 'bicycle', 3: 'car', 4: 'motorcycle',
    5: 'airplane', 6: 'bus', 7: 'train', 8: 'truck', 9: 'boat', 10: 'traffic light',
    11: 'fire hydrant', 12: 'stop sign', 13: 'parking meter', 14: 'bench', 15: 'bird',
    16: 'cat', 17: 'dog', 18: 'horse', 19: 'sheep', 20: 'cow', 21: 'elephant', 22: 'bear',
    23: 'zebra', 24: 'giraffe', 25: 'backpack', 26: 'umbrella', 27: 'handbag', 28: 'tie',
    29: 'suitcase', 30: 'frisbee', 31: 'skis', 32: 'snowboard', 33: 'sports ball',
    34: 'kite', 35: 'baseball bat', 36: 'baseball glove', 37: 'skateboard',
    38: 'surfboard', 39: 'tennis racket', 40: 'bottle', 41: 'wine glass', 42: 'cup',
    43: 'fork', 44: 'knife', 45: 'spoon', 46: 'bowl', 47: 'banana', 48: 'apple',
    49: 'sandwich', 50: 'orange', 51: 'broccoli', 52: 'carrot', 53: 'hot dog',
    54: 'pizza', 55: 'donut', 56: 'cake', 57: 'chair', 58: 'couch', 59: 'potted plant',
    60: 'bed', 61: 'dining table', 62: 'toilet', 63: 'tv', 64: 'laptop', 65: 'mouse',
    66: 'remote', 67: 'keyboard', 68: 'cell phone', 69: 'microwave', 70: 'oven',
    71: 'toaster', 72: 'sink', 73: 'refrigerator', 74: 'book', 75: 'clock', 76: 'vase',
    77: 'scissors', 78: 'teddy bear', 79: 'hair drier', 80: 'toothbrush'}

boxes = [[], [[1211.0322265625, 659.8157348632812, 1476.96875, 879.4646606445312, 0.643359899520874], [1886.4891357421875, 124.50743103027344, 1956.3607177734375, 300.12255859375, 0.720810055732727], [2367.838623046875, 343.97833251953125, 2468.394775390625, 461.1812744140625, 0.3665868937969208], [1644.389892578125, 153.90411376953125, 1709.783935546875, 304.7943420410156, 0.7120708227157593]], [[1788.8843994140625, 234.87916564941406, 1849.6573486328125, 332.4058532714844, 0.2873031795024872], [1147.3128662109375, 671.92041015625, 1381.1614990234375, 932.3116455078125, 0.2393173724412918]], [], [], [], [], [], [], [], [], [], [], [], [[1515.4610595703125, 365.98406982421875, 1627.6937255859375, 537.6974487304688, 0.3187636733055115], [1306.8363037109375, 391.0592346191406, 1612.6051025390625, 664.5523681640625, 0.178239107131958]], [], [], [[1184.05712890625, 658.5044555664062, 1462.04150390625, 861.7434692382812, 0.4417492151260376], [1177.683837890625, 677.3364868164062, 1397.20947265625, 804.9179077148438, 0.3158841133117676]], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [], [[617.2573852539062, 420.2257080078125, 647.1384887695312, 458.780029296875, 0.18951675295829773], [2082.781982421875, 582.6307373046875, 2116.611572265625, 621.70263671875, 0.15988394618034363], [1360.740234375, 964.4733276367188, 1422.037353515625, 1028.7957763671875, 0.400902658700943]], [], [], [], [[2031.66748046875, 589.2308349609375, 2122.29296875, 643.3558349609375, 0.2934456467628479]], [], [], [], [], [], [], [], [], [], [], [[1946.0496826171875, 347.2464294433594, 2060.4765625, 541.4993896484375, 0.950349748134613], [933.4570922851562, 321.46136474609375, 1050.6258544921875, 507.12847900390625, 0.9633166790008545], [1774.7760009765625, 564.6915893554688, 1973.4378662109375, 915.9603881835938, 0.9623499512672424], [1322.2685546875, 223.5082244873047, 1408.237548828125, 357.05926513671875, 0.9178719520568848], [1587.5130615234375, 911.7571411132812, 1863.8260498046875, 1361.346435546875, 0.9896822571754456], [1247.653076171875, 1098.8665771484375, 1604.151123046875, 1485.9066162109375, 0.9912063479423523], [481.9494323730469, 567.93994140625, 617.4140625, 919.9140625, 0.45577338337898254], [484.8003845214844, 631.5185546875, 568.4658203125, 887.651611328125, 0.8497243523597717], [779.8189697265625, 572.199462890625, 996.6160888671875, 932.37841796875, 0.9076002836227417], [1406.408203125, 228.54293823242188, 1493.237548828125, 376.3018493652344, 0.7989262342453003], [420.4252624511719, 492.9278259277344, 573.98876953125, 703.0936279296875, 0.7332886457443237], [598.2012939453125, 263.212890625, 650.7628173828125, 376.71337890625, 0.6585619449615479], [2218.046142578125, 641.196044921875, 2295.160888671875, 869.8272705078125, 0.5981748700141907], [781.5320434570312, 317.1724853515625, 927.6076049804688, 498.6324462890625, 0.9624705910682678], [878.8687744140625, 567.7732543945312, 966.488525390625, 653.0331420898438, 0.7208077907562256], [389.1669921875, 466.3056640625, 507.0133056640625, 679.3787841796875, 0.3145199120044708], [1158.2034912109375, 835.3544311523438, 1324.7100830078125, 942.9061889648438, 0.2249971181154251], [536.4205322265625, 243.57345581054688, 585.2518310546875, 368.2408752441406, 0.29398518800735474], [202.73033142089844, 313.3249816894531, 399.62841796875, 391.8120422363281, 0.1583428978919983], [1645.572998046875, 193.38832092285156, 1703.54296875, 325.69708251953125, 0.30740952491760254], [1772.9093017578125, 552.7213745117188, 1884.7574462890625, 874.2240600585938, 0.9423457980155945], [1515.5028076171875, 210.92691040039062, 1584.0848388671875, 361.4555358886719, 0.4538784623146057], [2015.66162109375, 631.7774047851562, 2282.03857421875, 978.2736206054688, 0.8177680969238281], [338.50262451171875, 356.3707580566406, 408.43280029296875, 519.90478515625, 0.30341005325317383], [877.9774169921875, 574.445068359375, 984.76416015625, 839.27099609375, 0.7372276186943054], [1803.823486328125, 315.490966796875, 1949.578857421875, 487.4202880859375, 0.9424840211868286], [1531.0728759765625, 218.90040588378906, 1574.8807373046875, 246.5392608642578, 0.2673698961734772], [779.3887329101562, 269.1250915527344, 922.8117065429688, 389.5387878417969, 0.2298305779695511], [383.90045166015625, 469.95574951171875, 417.64837646484375, 637.8683471679688, 0.18774129450321198], [1456.9637451171875, 223.6374053955078, 1565.4232177734375, 375.5633544921875, 0.20400522649288177], [1738.2965087890625, 221.9713592529297, 1798.4288330078125, 326.38726806640625, 0.6355493664741516], [780.225830078125, 511.6325988769531, 840.7359619140625, 596.6156005859375, 0.3189120888710022], [391.2608642578125, 396.73974609375, 573.6275634765625, 666.6470947265625, 0.3337574899196625], [661.8074951171875, 266.6794128417969, 784.9454345703125, 421.6407775878906, 0.8450517058372498], [2526.83056640625, 404.58441162109375, 2625.11669921875, 515.24609375, 0.1865910291671753], [1724.6019287109375, 223.53587341308594,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      1766.4454345703125, 323.1846923828125, 0.21577638387680054], [383.258056640625, 464.8293762207031, 445.58270263671875, 666.95361328125, 0.23264679312705994], [2020.765380859375, 265.4237060546875, 2075.126708984375, 339.9013671875, 0.17542250454425812], [499.63873291015625, 621.1798095703125, 812.5100708007812, 992.6024169921875, 0.3506334722042084], [1456.900146484375, 258.40972900390625, 1520.0302734375, 380.6292724609375, 0.34660741686820984], [1193.0338134765625, 383.5760192871094, 1323.1024169921875, 615.892333984375, 0.9862427711486816], [577.0107421875, 246.68545532226562, 629.3438720703125, 377.9494323730469, 0.25906288623809814], [558.5657348632812, 500.1918029785156, 617.5640258789062, 589.9680786132812, 0.357033371925354], [230.5794677734375, 370.8001708984375, 388.1868896484375, 556.7168579101562, 0.3883005678653717], [780.6441040039062, 308.7096252441406, 926.5222778320312, 364.4129943847656, 0.2811061441898346], [808.7076416015625, 262.5045166015625, 885.477294921875, 307.3807373046875, 0.21301794052124023], [1315.4576416015625, 391.3447265625, 1561.6844482421875, 663.8773193359375, 0.8764729499816895], [1496.43798828125, 361.1168518066406, 1631.91943359375, 610.710205078125, 0.3322412073612213], [609.5702514648438, 717.9632568359375, 824.2371215820312, 1007.8055419921875, 0.8917933702468872], [197.056884765625, 314.30767822265625, 397.10906982421875, 504.19085693359375, 0.31623953580856323], [597.740966796875, 551.3773193359375, 840.0185546875, 937.8873291015625, 0.32820925116539], [2.8853759765625, 117.50851440429688, 2331.302734375, 859.09521484375, 0.340660959482193], [2287.47216796875, 439.7063293457031, 2432.958984375, 652.7347412109375, 0.8297605514526367], [1002.4324340820312, 277.10968017578125, 1179.7078857421875, 505.38983154296875, 0.26367413997650146], [1157.441650390625, 733.3134765625, 1483.067138671875, 940.218994140625, 0.1776924729347229], [915.960205078125, 157.50909423828125, 2194.019287109375, 1218.68603515625, 0.16026462614536285]], [], [], [], [[1783.44189453125, 567.9711303710938, 2287.756591796875, 988.9271850585938, 0.9660497307777405], [963.7771606445312, 302.01092529296875, 1180.65625, 512.3626098632812, 0.8652337193489075], [969.1766967773438, 774.8732299804688, 1817.309814453125, 1434.854248046875, 0.9721973538398743], [215.26895141601562, 362.14117431640625, 405.1889953613281, 557.1836547851562, 0.45578283071517944], [512.58251953125, 570.2461547851562, 979.907958984375, 837.1727905273438, 0.9209420680999756], [390.63763427734375, 400.18896484375, 656.5894165039062, 625.1204833984375, 0.5382287502288818], [1345.10009765625, 383.93389892578125, 1612.3994140625, 649.3330688476562, 0.48547476530075073], [1699.96142578125, 204.1342010498047, 1829.596923828125, 224.9817352294922, 0.2572656273841858], [624.0967407226562, 595.1419067382812, 979.9633178710938, 973.9613647460938, 0.15798676013946533], [691.4110107421875, 253.7154541015625, 1157.738037109375, 425.13812255859375, 0.17514313757419586], [1456.1895751953125, 240.54373168945312, 1572.1749267578125, 375.2927551269531, 0.4733242392539978], [653.6698608398438, 264.2965087890625, 812.6820678710938, 411.82781982421875, 0.1661987453699112], [1089.773193359375, 193.96510314941406, 1218.048095703125, 227.2639617919922, 0.1867896467447281], [1703.06640625, 198.6737518310547, 1825.8798828125, 217.13526916503906, 0.4629287123680115], [663.796142578125, 269.0286560058594, 811.894287109375, 293.0379333496094, 0.18436318635940552], [661.819580078125, 275.36492919921875, 810.3701171875, 309.87554931640625, 0.31642791628837585], [1762.5843505859375, 192.5848388671875, 1828.6505126953125, 222.38174438476562, 0.2042444944381714], [1459.4971923828125, 245.10159301757812, 1562.9437255859375, 273.6904602050781, 0.5181407928466797], [2337.6787109375, 418.8370666503906, 2640.48779296875, 706.6632080078125, 0.4704611301422119], [242.00144958496094, 351.424560546875, 653.0506591796875, 563.7720947265625, 0.20871712267398834], [870.4126586914062, 249.0655975341797, 1116.5562744140625, 486.9876708984375, 0.20082110166549683], [1793.0494384765625, 543.923583984375, 2276.947021484375, 773.734619140625, 0.3756902813911438], [621.0458984375, 243.79718017578125, 1108.619873046875, 325.8760986328125, 0.1821984350681305]], [], [[314.3237609863281, 69.6445541381836, 467.5575256347656, 270.3941345214844, 0.8130568265914917]], [], [], [], [], [[1315.412353515625, 919.573974609375, 1383.33056640625, 945.2685546875, 0.4864797592163086]], [], [], [], [], [], [[665.402587890625, 596.9674072265625, 773.8187255859375, 650.6475830078125, 0.6642021536827087], [525.1039428710938, 418.7573547363281, 637.5703735351562, 483.9897766113281, 0.31716388463974]], [], [[2026.1453857421875, 257.9519958496094, 2077.93798828125, 345.4098205566406, 0.35716691613197327], [446.3107604980469, 350.2361145019531, 519.4441528320312, 453.1379089355469, 0.25176694989204407], [445.4372253417969, 394.86712646484375, 506.2228698730469, 456.3463134765625, 0.21999472379684448]], [], [], [], []]
table_coords = []
chair_coords = []

tables = []
orphans = []

def printDDA(dda):
    for arr in dda:
        print(arr, end="\n")


def printTables():
    for table in tables:
        print("Confidence %2f | Centroid %0.2d, %0.2d" %
              (table['confidence'], *table['centroid']), end="\n")
        print("------------------------------------")
        for chair in table['chairs']:
            print("Confidence %2f | Centroid %0.2d, %0.2d" %
                  (chair['confidence'], *chair['centroid']), end="\n")
        print("------------------------------------")
        print("\n")


def cleanChairs():
    for table in tables:
        if len(table['chairs']) < 2:
            continue
        table['chairs'].sort(key=lambda x: x['centroid'][0])
        temp = []
        for i in range(len(table['chairs'])-1):
            if (abs(table['chairs'][i]['centroid'][0]-table['chairs'][i+1]['centroid'][0]) > 50) or \
                    (abs(table['chairs'][i]['centroid'][1]-table['chairs'][i+1]['centroid'][1]) > 50):
                temp.append(table['chairs'][i])
        temp.append(table['chairs'][len(table['chairs'])-1])
        table['chairs'] = temp
        print(table['chairs'])


def mapChairToTable():
    not_orphans = set()
    for table in table_coords:
        temp = {'centroid': centroid(
            *table[0:4]), 'chairs': [], 'confidence': table[4]}
        min = 20000000000
        for chair in chair_coords:
            gap = dist(*temp['centroid'],
                       *centroid(chair[0], chair[1], chair[2], chair[3]))
            if(gap < min):
                min = gap
        print(min, end="\n")
        min = max(min, dist(table[0], table[1], *temp['centroid']))
        for chair in chair_coords:
            c = centroid(chair[0], chair[1], chair[2], chair[3])
            gap = dist(*temp['centroid'], *c)
            if(gap < min):
                not_orphans.add(str(c[0])+" "+str(c[1]))    
                temp['chairs'].append(
                    {'centroid': c, 'confidence': chair[4]})
        tables.append(temp)
    if len(not_orphans)-len(chair_coords) == 0:
        return
    orphan_table = {'centroid': [-1,-1], 'chairs': [], 'confidence': -1}
    for chair in chair_coords:
        c = centroid(chair[0], chair[1], chair[2], chair[3])
        if not str(c[0])+" "+str(c[1]) in not_orphans:
            orphan_table['chairs'].append({'centroid': c, 'confidence': chair[4]})
    tables.append(orphan_table)   

def tableSizes():
    for table in table_coords:
        print(table, end="\n")
        print(dist(table[0], table[1], table[2], table[3]), end="\n\n")


def getTables():
    for table in boxes[61]:
        if(table[4] > .7):
            table_coords.append(table)
    # print(tables, end="\n\n")


def getChairs():
    for chair in boxes[57]:
        if(chair[4] > .7):
            chair_coords.append(chair)
    print(len(chair_coords))
    # print(chairs, end="\n\n")


def dist(x1, y1, x2, y2):
    return pow(pow(x1-x2, 2)+pow(y1-y2, 2), 0.5)


def centroid(x1, y1, x2, y2):
    return [0.5*(x1+x2), 0.5*(y1+y2)]


if __name__ == "__main__":
    im = Image.open('/home/adhrit/Downloads/old.jpg')
    width, height = im.size
    print(width, height)
    getTables()
    getChairs()
    # tableSizes()
    mapChairToTable()
    printTables()
    cleanChairs()
    printTables()
